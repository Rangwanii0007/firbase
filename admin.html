<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Referral Engagement Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6f9; }
    h2 { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #2c3e50; color: white; }
    tr:hover { background: #f1f1f1; cursor: pointer; }
    .details-box { display:none; background:#fff; padding:20px; margin-top:20px; border:1px solid #ddd; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    .highlight { background: #27ae60; color:white; padding:3px 8px; border-radius:5px; }
  </style>
</head>
<body>
  <h2>Referral Engagement Dashboard (with Score & Ranking)</h2>
  <table id="refTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Email</th>
        <th>Total Users</th>
        <th>Active Users</th>
        <th>Offline Users</th>
        <th>Fake Users</th>
        <th>Active %</th>
        <th>Total Score</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="refTableBody"></tbody>
  </table>

  <div id="detailsBox" class="details-box"></div>

  <script type="module">
    // Firebase setup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Score distribution by region
    const regionScores = {
      "Asia": 130,
      "Europe": 370,
      "Middle East": 350,
      "Other": 100
    };

    function calculateScore(user) {
      let base = 10; // per invite
      let regionBonus = regionScores[user.countryRegion] || regionScores["Other"];
      return base + regionBonus;
    }

    function renderTable(data) {
      let tbody = document.getElementById("refTableBody");
      tbody.innerHTML = "";

      // Calculate scores per referrer
      let referrers = Object.keys(data).map((name) => {
        let info = data[name];
        let users = info.users || [];
        let total = users.length;
        let active = users.filter(u => u.active).length;
        let fake = users.filter(u => u.fake).length;
        let offline = total - active;
        let activePct = total > 0 ? ((active/total)*100).toFixed(1) + "%" : "0%";

        let totalScore = users.reduce((sum,u)=> sum+calculateScore(u), 0);

        return {
          name: name,
          email: info.email,
          total,
          active,
          offline,
          fake,
          activePct,
          totalScore,
          users
        };
      });

      // Sort by score for ranking
      referrers.sort((a,b)=> b.totalScore - a.totalScore);

      // Render
      referrers.forEach((r, i)=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="highlight">#${i+1}</span></td>
          <td>${r.name}</td>
          <td>${r.email}</td>
          <td>${r.total}</td>
          <td>${r.active}</td>
          <td>${r.offline}</td>
          <td>${r.fake}</td>
          <td>${r.activePct}</td>
          <td><b>${r.totalScore}</b></td>
          <td><button onclick='showDetails(${JSON.stringify(r)})'>Details</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Show details breakdown
    window.showDetails = function(ref){
      let box = document.getElementById("detailsBox");
      let regionBreakdown = {};
      ref.users.forEach(u=>{
        let region = u.countryRegion || "Other";
        if(!regionBreakdown[region]) regionBreakdown[region]=0;
        regionBreakdown[region]+= calculateScore(u);
      });

      let regionHTML = Object.entries(regionBreakdown).map(([region,score])=>
        `<li>${region}: ${score} pts</li>`
      ).join("");

      let usersHTML = ref.users.map(u=>
        `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.ip}</td><td>${u.countryRegion}</td><td>${u.active?"✅":"❌"}</td><td>${u.fake?"⚠️":""}</td></tr>`
      ).join("");

      box.innerHTML = `
        <h3>${ref.name} - Referral Details</h3>
        <p>Email: ${ref.email}</p>
        <p><b>Total Score:</b> ${ref.totalScore}</p>
        <p><b>Score by Region:</b></p>
        <ul>${regionHTML}</ul>
        <h4>Invited Users:</h4>
        <table>
          <tr><th>Name</th><th>Email</th><th>IP</th><th>Country</th><th>Active</th><th>Fake</th></tr>
          ${usersHTML}
        </table>
      `;
      box.style.display="block";
    }

    // Listen to realtime database
    const refDb = ref(db,"referrals");
    onValue(refDb, (snapshot)=>{
      if(snapshot.exists()) renderTable(snapshot.val());
    });
  </script>
</body>
</html>
