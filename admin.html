<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Hacker Affiliate Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Globe + Chart -->
  <script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#00050a; --panel:#021217; --grid:#06282e; --neon:#00ff88; --neon2:#39ff14; --muted:#78b3a3; --accent:#12e3ff; --bad:#ff4d4d; --warn:#ffd166; --ok:#50fa7b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:#d7fff1;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
    .wrap{max-width:1400px;margin:16px auto;padding:0 12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    .card{background:linear-gradient(180deg,#001015,#001a22);border:1px solid var(--grid);border-radius:14px;box-shadow:0 0 24px rgba(0,255,136,.05);padding:12px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.6px}
    .title .dot{width:8px;height:8px;border-radius:50%;background:var(--neon);box-shadow:0 0 12px var(--neon)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button{background:#00161d;border:1px solid #07343d;color:#bffff0;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #07343d;text-align:center}
    thead th{position:sticky;top:0;background:#00161d;border-bottom:1px solid #0a3a45}
    .badge{padding:3px 8px;border-radius:999px;background:var(--neon);color:#00130e;font-weight:700}
    .muted{color:var(--muted)}
    .pill{padding:2px 8px;border-radius:8px;border:1px solid #0f3;box-shadow:0 0 10px rgba(0,255,136,.2)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .mini{font-size:12px}
    .globeWrap{height:460px;border-radius:12px;overflow:hidden}
    dialog{border:none;border-radius:14px;max-width:1000px;width:92%;background:#00161d;color:#d7fff1}
    .dlg-h{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #07343d}
    .dlg-b{padding:10px;max-height:70vh;overflow:auto}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Login -->
  <div class="card" id="login">
    <div class="title"><span class="dot"></span> Secure Admin Access</div>
    <div class="row" style="margin-top:8px">
      <input id="u" placeholder="username" value="admin">
      <input id="p" type="password" placeholder="password">
      <button id="go">Enter</button>
      <span class="muted mini">Hint: admin / nadeem</span>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash" style="display:none">
    <div class="grid">
      <div class="card">
        <div class="title"><span class="dot"></span> Live World Map (joins in realtime)</div>
        <div id="globe" class="globeWrap"></div>
        <div class="mini muted">Glowing rings = new visits. Lines show recent burst activity.</div>
      </div>
      <div class="card">
        <div class="title"><span class="dot"></span> CPM Breakdown (selected referrer)</div>
        <div class="row" style="margin-top:6px">
          <select id="refPick"></select>
          <button id="csv">Export CSV</button>
          <input id="q" placeholder="Search name…" class="right">
        </div>
        <canvas id="bar" height="220" style="margin-top:8px"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title"><span class="dot"></span> Leaderboard (realtime)</div>
      <table>
        <thead>
          <tr>
            <th>Rank</th><th>Name</th><th>Gmail</th><th>Total</th><th>Active 24h</th><th>Offline</th><th>Fake (same IP)</th><th>Active %</th><th>Score</th><th>Details</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="10" class="muted">Listening…</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<dialog id="dlg">
  <div class="dlg-h">
    <strong id="dlgT">Details</strong>
    <button id="close" style="margin-left:auto">Close</button>
  </div>
  <div class="dlg-b">
    <div class="mini muted" id="sum"></div>
    <table style="width:100%;border-collapse:collapse;margin-top:8px">
      <thead><tr><th>Email</th><th>Verified</th><th>Country</th><th>IP</th><th>When</th><th>Active</th></tr></thead>
      <tbody id="dlgB"></tbody>
    </table>
  </div>
</dialog>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ---------- Auth gate ----------
const go = document.getElementById('go'), u=document.getElementById('u'), p=document.getElementById('p');
const login = document.getElementById('login'), dash=document.getElementById('dash');
go.onclick=()=>{ if(u.value.trim()==='admin' && p.value.trim()==='nadeem'){ login.style.display='none'; dash.style.display='block'; boot(); } else alert('Wrong'); };

// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// ---------- Helpers ----------
function regionScore(country){
  const c = (country||"").toLowerCase();
  if(["united states","usa","canada","united kingdom","uk","england","scotland","wales","northern ireland"].includes(c)) return 500;
  if(["germany","france","italy","spain","netherlands","sweden","norway","denmark","finland","belgium","switzerland","austria","ireland","portugal","poland","europe"].includes(c)) return 370;
  if(["united arab emirates","uae","saudi arabia","qatar","kuwait","bahrain","oman","middle east"].includes(c)) return 350;
  return 130;
}
function niceTime(ts){
  const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : new Date());
  return d.toLocaleString();
}
function isActive24(ts){
  const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : new Date());
  return (Date.now() - d.getTime()) <= 24*60*60*1000;
}

// ---------- Globe ----------
let globe, gInstance;
function buildGlobe(){
  if(gInstance) return gInstance;
  const el = document.getElementById("globe");
  gInstance = Globe()
    (el)
    .globeImageUrl("//unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
    .bumpImageUrl("//unpkg.com/three-globe/example/img/earth-topology.png")
    .backgroundColor("rgba(0,0,0,0)")
    .pointsData([])
    .pointAltitude(0.01)
    .pointColor(()=>"#39ff14")
    .ringsData([])
    .ringColor(()=> (t)=>`rgba(57,255,20,${1-t})`)
    .ringMaxRadius(3)
    .ringPropagationSpeed(2)
    .ringRepeatPeriod(1000);
  return gInstance;
}
function pulse(lat,lon){
  if(lat==null || lon==null) return;
  const rings = gInstance.ringsData();
  rings.push({ lat, lng: lon, maxR:3 });
  if(rings.length>200) rings.shift();
  gInstance.ringsData(rings);
}

// ---------- Charts ----------
let barChart;
function updateBarChart(dataset){
  const ctx = document.getElementById('bar').getContext('2d');
  const labels = ["Premium (US/CA/UK)", "Europe", "Middle East", "Asia/Other"];
  const data = [
    dataset.premium||0,
    dataset.europe||0,
    dataset.me||0,
    dataset.asia||0
  ];
  if(barChart){ barChart.data.datasets[0].data = data; barChart.update(); return; }
  barChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'CPM Score Contribution', data }] },
    options: {
      plugins:{ legend:{labels:{color:'#bffff0'}} },
      scales:{
        x:{ ticks:{color:'#bffff0'}, grid:{color:'#07343d'} },
        y:{ ticks:{color:'#bffff0'}, grid:{color:'#07343d'} }
      }
    }
  });
}

// ---------- UI refs ----------
const tbody = document.getElementById('tbody');
const q = document.getElementById('q');
const refPick = document.getElementById('refPick');
const csvBtn = document.getElementById('csv');
const dlg = document.getElementById('dlg'), dlgB=document.getElementById('dlgB'), dlgT=document.getElementById('dlgT'), dlgClose=document.getElementById('close'), sum=document.getElementById('sum');
dlgClose.onclick=()=>dlg.close();

// ---------- Data & live render ----------
let docs = [];
function aggregate(){
  // group by referrer
  const by = {};
  docs.forEach(d=>{
    const name = (d.referrer||"unknown").toLowerCase();
    by[name] ||= { name, gmail:"N/A", visits:[] };
    if(d.email && by[name].gmail==="N/A") by[name].gmail = d.email;
    by[name].visits.push(d);
  });

  const rows = [];
  Object.values(by).forEach(ref=>{
    const ipCount = {};
    let total=0, active=0, offline=0, fake=0, score=0;
    let premium=0,europe=0,me=0,asia=0;
    const countries = {};
    ref.visits.forEach(v=>{
      total++;
      const act = isActive24(v.ts);
      if(act) active++; else offline++;
      const ip = v.ip||"";
      ipCount[ip]=(ipCount[ip]||0)+1;

      const c = (v.country||"Unknown");
      countries[c]=(countries[c]||0)+1;

      const rs = regionScore(c);
      if(rs===500) premium += (10+rs);
      else if(rs===370) europe += (10+rs);
      else if(rs===350) me += (10+rs);
      else asia += (10+rs);
      score += (10 + rs);
    });
    Object.values(ipCount).forEach(n=>{ if(n>1) fake += (n-1); });
    const activePct = total ? Math.round(active/total*100) : 0;
    rows.push({
      name: ref.name,
      gmail: ref.gmail,
      total, active, offline, fake, activePct, score,
      visits: ref.visits,
      countries, buckets:{premium,europe,me,asia}
    });
  });

  rows.sort((a,b)=> b.score - a.score);
  return rows;
}

function render(){
  const rows = aggregate();
  // fill refPick
  const options = rows.map(r=>`<option value="${r.name}">${r.name.toUpperCase()}</option>`).join("");
  refPick.innerHTML = "<option value=''>Select referrer…</option>"+options;

  // table
  const term = (q.value||"").toLowerCase();
  const list = rows.filter(r=> r.name.includes(term));
  tbody.innerHTML = list.length ? list.map((r,i)=>{
    const badge = i===0?`<span class="badge">TOP 1</span>`:i===1?`<span class="badge">TOP 2</span>`:i===2?`<span class="badge">TOP 3</span>`:"";
    const cls = r.activePct>=60?'ok':r.activePct>=30?'warn':'bad';
    return `<tr>
      <td>${i+1} ${badge}</td>
      <td>${r.name.toUpperCase()}</td>
      <td>${r.gmail}</td>
      <td>${r.total}</td>
      <td>${r.active}</td>
      <td>${r.offline}</td>
      <td>${r.fake}</td>
      <td><span class="pill ${cls}">${r.activePct}%</span></td>
      <td>${r.score}</td>
      <td><button class="det" data-name="${r.name}">Details</button></td>
    </tr>`;
  }).join("") : `<tr><td colspan="10" class="muted">No data</td></tr>`;

  // details handlers
  document.querySelectorAll("button.det").forEach(b=>{
    b.onclick = ()=>{
      const name = b.dataset.name;
      const rows = aggregate();
      const r = rows.find(x=>x.name===name);
      if(!r) return;
      dlgT.textContent = `Details — ${name.toUpperCase()}`;
      // country summary
      const parts = Object.entries(r.countries).sort((a,b)=>b[1]-a[1]).map(([c,n])=>`${c}: ${n}`).join(" · ");
      sum.textContent = parts ? `Countries: ${parts}` : "Countries: N/A";
      // rows
      dlgB.innerHTML = r.visits.map(v=>{
        const act = isActive24(v.ts);
        return `<tr>
          <td>${v.email||"N/A"}</td>
          <td>${v.verified ? "Yes" : "No"}</td>
          <td>${v.country||"Unknown"}</td>
          <td>${v.ip||"N/A"}</td>
          <td>${niceTime(v.ts)}</td>
          <td>${act ? "Yes" : "No"}</td>
        </tr>`;
      }).join("");
      dlg.showModal();

      // update CPM bar for this referrer
      updateBarChart(r.buckets);
    };
  });

  // default bar = all rows sum (optional)
  const totalBuckets = rows.reduce((acc,r)=>{
    acc.premium += r.buckets.premium; acc.europe += r.buckets.europe; acc.me += r.buckets.me; acc.asia += r.buckets.asia;
    return acc;
  }, {premium:0,europe:0,me:0,asia:0});
  updateBarChart(totalBuckets);
}

// CSV
document.getElementById('csv').onclick = ()=>{
  const rows = aggregate();
  let csv = "Rank,Name,Gmail,Total,Active24h,Offline,Fake,Active%,Score\n";
  rows.forEach((r,i)=>{
    csv += [i+1,r.name,r.gmail,r.total,r.active,r.offline,r.fake,`${r.activePct}%`,r.score].join(",")+"\n";
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download = "leaderboard.csv"; a.click();
};

// search
document.getElementById('q').addEventListener('input', render);

// ---------- Boot (live) ----------
function boot(){
  // globe
  buildGlobe();

  // realtime snapshot
  onSnapshot(collection(db,"referrals"), snap=>{
    const added = [];
    docs = snap.docs.map(d=>{
      const v = d.data();
      // pulse new-ish (last 10s) items
      const t = v.ts?.toDate ? v.ts.toDate().getTime() : (v.ts ? new Date(v.ts).getTime() : Date.now());
      if(Date.now() - t < 10*1000){ added.push(v); }
      return v;
    });
    // push globe points & rings
    const pts = docs.filter(v => v.lat!=null && v.lon!=null).slice(-500).map(v=>({lat:v.lat,lng:v.lon,size:0.6}));
    gInstance.pointsData(pts);
    added.forEach(v=> pulse(v.lat, v.lon));
    render();
  });
}
</script>
</body>
</html>
