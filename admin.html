<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Affiliate — Hacker Live Dashboard</title>

<!-- libs -->
<script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{ --bg:#00050a; --neon:#19ff5f; --muted:#7fbfb0; --panel:#03161d; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000; color:#c8ffe3; font-family:ui-monospace,monospace; overflow:hidden}
  .wrap{position:relative;z-index:2;max-width:1400px;margin:12px auto;padding:12px}
  .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:12px}
  .card{background:linear-gradient(180deg,#001116,#001a22);border:1px solid #07343d;border-radius:12px;padding:12px}
  .title{display:flex;align-items:center;gap:8px;font-weight:800}
  .dot{width:9px;height:9px;border-radius:50%;background:var(--neon);box-shadow:0 0 10px var(--neon)}
  input,select,button{background:#00161d;border:1px solid #0b3a44;color:#bffff0;border-radius:8px;padding:8px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #07343d;text-align:center;font-size:13px}
  thead th{position:sticky;top:0;background:#00161d}
  .globeWrap{height:520px;border-radius:10px;overflow:hidden}
  .feed{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.85);padding:8px;border-top:1px solid #07343d;max-height:28vh;overflow:auto}
  .feed-row{display:grid;grid-template-columns:1.4fr .6fr .6fr .6fr;gap:8px;padding:6px 0;border-bottom:1px dashed #07343d}
  .pill{padding:3px 8px;border-radius:999px;background:rgba(25,255,128,.06)}
  button.small{padding:6px 8px}
  dialog{border:none;border-radius:10px;background:#02171a;color:#c8ffe3}
</style>
</head>
<body>
<div class="wrap">
  <div id="loginCard" class="card">
    <div class="title"><div class="dot"></div> Admin Login</div>
    <div style="margin-top:8px">
      <input id="user" placeholder="admin" value="admin">
      <input id="pass" placeholder="password" type="password">
      <button id="loginBtn">Open</button>
      <span class="small" style="margin-left:10px;color:#9fb">Hint: admin / nadeem</span>
    </div>
  </div>

  <div id="main" style="display:none">
    <div class="grid">
      <div class="card">
        <div class="title"><div class="dot"></div> Earth — Live Joins</div>
        <div id="globe" class="globeWrap"></div>
        <div class="small" style="margin-top:6px;color:#9fb">Pulses = new joins; arcs = inviter → invitee (animated)</div>
      </div>

      <div class="card">
        <div class="title"><div class="dot"></div> Controls & CPM</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <select id="refPick"><option value="">All referrals…</option></select>
          <input id="search" placeholder="Search name…">
          <button id="exportCsv" class="small">CSV</button>
        </div>
        <canvas id="cpmChart" height="260" style="margin-top:12px"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px;max-height:38vh;overflow:auto">
      <div class="title"><div class="dot"></div> Leaderboard (Realtime)</div>
      <table>
        <thead><tr><th>Rank</th><th>Name</th><th>Email</th><th>Total</th><th>Active24</th><th>Offline</th><th>Fake</th><th>Active%</th><th>Score</th><th>Details</th></tr></thead>
        <tbody id="leaderbody"><tr><td colspan="10" class="muted">Waiting…</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div id="feed" class="feed"></div>

<!-- Details modal -->
<dialog id="detailsDlg">
  <div style="padding:12px">
    <div style="display:flex;align-items:center;gap:8px">
      <strong id="dTitle">Details</strong>
      <button id="dClose" style="margin-left:auto">Close</button>
    </div>
    <div id="dSummary" class="small" style="margin-top:6px"></div>
    <table style="width:100%;margin-top:8px"><thead><tr><th>Email</th><th>Verified</th><th>Country</th><th>IP</th><th>When</th><th>Active</th></tr></thead><tbody id="dBody"></tbody></table>
  </div>
</dialog>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// ---------- Firebase config (use your project) ----------
const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Helpers ----------
function niceTime(ts){ const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : new Date()); return d.toLocaleString(); }
function isActive24(ts){ const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : new Date()); return (Date.now() - d.getTime()) <= 24*60*60*1000; }
function regionScore(country){
  const c=(country||"").toLowerCase(); if(["usa","united states","canada","uk"].some(x=>c.includes(x))) return 500;
  if(["germany","france","italy","spain"].some(x=>c.includes(x))) return 370;
  if(["uae","saudi","qatar"].some(x=>c.includes(x))) return 350; return 130;
}

// ---------- UI refs ----------
const loginBtn = document.getElementById('loginBtn'), userEl = document.getElementById('user'), passEl = document.getElementById('pass');
const loginCard = document.getElementById('loginCard'), main = document.getElementById('main');
const leaderbody = document.getElementById('leaderbody'), feed = document.getElementById('feed');
const refPick = document.getElementById('refPick'), search = document.getElementById('search'), exportCsv = document.getElementById('exportCsv');
const detailsDlg = document.getElementById('detailsDlg'), dClose = document.getElementById('dClose'), dTitle = document.getElementById('dTitle'), dSummary = document.getElementById('dSummary'), dBody = document.getElementById('dBody');

dClose.onclick = ()=> detailsDlg.close();

// ---------- globe ----------
let gInstance;
function buildGlobe(){
  if(gInstance) return gInstance;
  const el = document.getElementById('globe');
  gInstance = Globe()(el)
    .globeImageUrl("//unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
    .bumpImageUrl("//unpkg.com/three-globe/example/img/earth-topology.png")
    .backgroundColor("rgba(0,0,0,0)")
    .pointsData([])
    .pointAltitude(0.02)
    .pointColor(d=>d.color)
    .arcsData([])
    .arcColor(a=>a.color)
    .arcDashLength(0.4)
    .arcDashGap(0.6)
    .arcDashAnimateTime(4000)
    .arcStroke(0.6);
  return gInstance;
}

function pulse(lat,lon,verified){
  if(!gInstance || lat==null || lon==null) return;
  const rings = gInstance.ringsData() || [];
  rings.push({ lat, lng: lon, verified: !!verified });
  if(rings.length>300) rings.shift();
  gInstance.ringsData(rings);
}

// ---------- aggregate + render ----------
let raw = [];
function aggregate(){
  const by = {};
  raw.forEach(d=>{
    const name = (d.referrer||"unknown").toLowerCase();
    if(!by[name]) by[name] = { name, email:"N/A", visits:[] };
    if(d.email && d.email!=="N/A" && by[name].email==="N/A") by[name].email = d.email;
    by[name].visits.push(d);
  });

  const rows = [];
  Object.values(by).forEach(r=>{
    const ipCount = {}; let total=0, active=0, offline=0, fake=0, score=0; const countries={};
    r.visits.forEach(v=>{
      total++; if(isActive24(v.ts)) active++; else offline++;
      ipCount[v.ip || ""] = (ipCount[v.ip || ""]||0)+1;
      const c = v.country || "Unknown"; countries[c] = (countries[c]||0)+1;
      score += (v.score || (10 + regionScore(c)));
    });
    Object.values(ipCount).forEach(n=>{ if(n>1) fake += (n-1); });
    const activePct = total ? Math.round(active/total*100) : 0;
    rows.push({ name: r.name, email: r.email, total, active, offline, fake, activePct, score, visits: r.visits, countries });
  });

  rows.sort((a,b)=>b.score - a.score);
  return rows;
}

function render(){
  const rows = aggregate();
  refPick.innerHTML = "<option value=''>All referrals…</option>" + rows.map(r=>`<option value="${r.name}">${r.name.toUpperCase()}</option>`).join("");
  const term = (search.value || "").toLowerCase();
  const list = rows.filter(r => r.name.includes(term));
  leaderbody.innerHTML = list.length ? list.map((r,i)=>`
    <tr>
      <td>${i+1}${i===0?'<span class="pill">TOP</span>':''}</td>
      <td>${r.name.toUpperCase()}</td>
      <td>${r.email}</td>
      <td>${r.total}</td>
      <td>${r.active}</td>
      <td>${r.offline}</td>
      <td>${r.fake}</td>
      <td><span class="pill">${r.activePct}%</span></td>
      <td>${r.score}</td>
      <td><button class="det" data-name="${r.name}">Details</button></td>
    </tr>
  `).join("") : `<tr><td colspan="10" class="muted">No data</td></tr>`;

  document.querySelectorAll(".det").forEach(b=>{
    b.onclick = ()=>{
      const name = b.dataset.name;
      const r = rows.find(x=>x.name===name);
      if(!r) return;
      dTitle.textContent = `Details — ${name.toUpperCase()}`;
      dSummary.textContent = Object.entries(r.countries).map(([c,n])=>`${c}: ${n}`).join(' · ');
      dBody.innerHTML = r.visits.map(v=>`<tr><td>${v.email||'N/A'}</td><td>${v.verified? 'Yes':'No'}</td><td>${v.country||'N/A'}</td><td>${v.ip||'N/A'}</td><td>${niceTime(v.ts)}</td><td>${isActive24(v.ts)?'Yes':'No'}</td></tr>`).join('');
      detailsDlg.showModal();

      // focus globe to this referrer with arcs & points
      const pts = r.visits.filter(v=>v.lat!=null && v.lon!=null).map(v=>({lat:v.lat,lng:v.lon,size:0.9,color:v.verified?"#39ff14":"#12e3ff"}));
      gInstance.pointsData(pts);

      // show arcs: if inviter exists (we look for docs where email matches and get inviter lat)
      // build arcs for this referrer: for each visit, try to find inviter location from raw
      const arcs = [];
      r.visits.forEach(v=>{
        // find the inviter doc in raw by referrer name? we use v.referrerRaw?
        // here we try: find an inviter doc where doc.id? fallback: draw small pulse only
      });
      // (arc drawing from inviter → invitee requires having inviter lat/lon known in docs; main dataset raw contains that)
      // We'll draw arcs globally in the main realtime loop below where inviter relationships are found.
    };
  });

  // update CPM chart total (simple)
  const totals = rows.reduce((acc,r)=>{ acc.totalScore=(acc.totalScore||0)+r.score; return acc; }, {});
  // (we can compute buckets per country for chart; omitted for brevity)
}

// ---------- realtime snapshot ----------
function startRealtime(){
  gInstance = buildGlobe();

  const col = collection(db,'referrals');
  onSnapshot(col, snap=>{
    raw = snap.docs.map(d=>d.data());
    // compute globe points (all validated docs with lat/lon)
    const pts = raw.filter(v=>v.lat!=null && v.lon!=null).slice(-1000).map(v=>({lat:v.lat,lng:v.lon,size:0.6,color:v.verified?"#39ff14":"#12e3ff"}));
    gInstance.pointsData(pts);

    // construct arcs: for each visit where referrer has a lat/lon, draw arc from referrer location to this visit
    const arcs = [];
    const byRef = {};
    raw.forEach(v => { const n = (v.referrer||"unknown").toLowerCase(); if(!byRef[n]) byRef[n]=[]; byRef[n].push(v); });
    // build a small map of latest referrer location (we assume a referrer may have at least one visit doc with lat/lon)
    const refLoc = {};
    Object.keys(byRef).forEach(name=>{
      const docs = byRef[name].filter(x => x.lat!=null && x.lon!=null);
      if(docs.length) refLoc[name] = {lat: docs[0].lat, lon: docs[0].lon}; // pick first found
    });
    raw.forEach(v=>{
      const inviter = (v.referrer||"").toLowerCase();
      if(refLoc[inviter] && v.lat!=null && v.lon!=null){
        arcs.push({
          startLat: refLoc[inviter].lat,
          startLng: refLoc[inviter].lon,
          endLat: v.lat,
          endLng: v.lon,
          color: v.verified ? '#39ff14' : '#12e3ff'
        });
      }
    });
    gInstance.arcsData(arcs);

    // pulse recent docs (<8s) and push to feed
    raw.forEach(v=>{
      const t = v.ts?.toDate ? v.ts.toDate().getTime() : (v.ts ? new Date(v.ts).getTime() : 0);
      if(Date.now() - t < 8000){ pulse(v.lat, v.lon, v.verified); pushFeed(v); }
    });

    render();
  });
}

// feed
function pushFeed(v){
  const row = document.createElement('div');
  row.className = 'feed-row';
  row.innerHTML = `<div>${v.email && v.email!=='N/A' ? v.email : '<span class="muted">Unknown</span>'}</div><div>${v.country||'<span class="muted">Unknown</span>'}</div><div>${v.ip||'N/A'}</div><div>${(v.referrer||'unknown').toUpperCase()}</div>`;
  feed.prepend(row);
  while(feed.children.length>120) feed.removeChild(feed.lastChild);
}

// CSV export
exportCsv.onclick = ()=>{
  const rows = aggregate();
  let csv = 'Rank,Name,Email,Total,Active24,Offline,Fake,Active%,Score\n';
  rows.forEach((r,i)=> csv += [i+1,r.name,r.email,r.total,r.active,r.offline,r.fake,r.activePct + '%', r.score].join(',') + '\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'leaderboard.csv'; a.click();
};

// interactions
loginBtn.onclick = ()=>{
  if(userEl.value.trim()==='admin' && passEl.value.trim()==='nadeem'){
    loginCard.style.display='none'; main.style.display='block';
    startRealtime();
  } else alert('Wrong credentials');
};
search.addEventListener('input', render);
refPick.addEventListener('change', (e)=> {
  const pick = (e.target.value||'').toLowerCase();
  if(!pick){
    const pts = raw.filter(v=>v.lat!=null && v.lon!=null).slice(-800).map(v=>({lat:v.lat,lng:v.lon,size:0.6,color:v.verified?"#39ff14":"#12e3ff"}));
    gInstance.pointsData(pts); gInstance.arcsData([]);
  } else {
    const pts = raw.filter(v=> (v.referrer||'').toLowerCase()===pick && v.lat!=null && v.lon!=null).map(v=>({lat:v.lat,lng:v.lon,size:0.9,color:v.verified?"#39ff14":"#12e3ff"}));
    gInstance.pointsData(pts);
    // arcs for this referrer handled in onSnapshot if needed
  }
});
</script>
</body>
</html>
