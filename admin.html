<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Affiliate Leaderboard (Admin)</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f7fb;padding:20px;}
    .card{max-width:1000px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.06);}
    table{width:100%;border-collapse:collapse;margin-top:12px;}
    th,td{padding:10px;border:1px solid #eee;text-align:center;}
    th{background:#f0f6ff;}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px;}
    button{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
    .small{font-size:13px;color:#666;}
  </style>
</head>
<body>

<div class="card" id="dashboard" style="display:none;">
  <h2>Affiliate Leaderboard (Realtime)</h2>
  <div class="small">Active = visited in last 24h · Fake = multiple accounts from same IP</div>

  <div class="controls">
    <button id="refreshBtn">Refresh Now</button>
    <button id="exportCsv">Export CSV</button>
    <label style="margin-left:auto" class="small">Auto-refresh: <input id="autoRefresh" type="checkbox"/></label>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Total Invites</th>
        <th>Active (24h)</th>
        <th>Offline</th>
        <th>Fake</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody id="tBody">
      <tr><td colspan="7">Loading…</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
  // ----- PASSWORD PROTECTION -----
  let password = prompt("Enter admin password:");
  if(password !== "nadeem"){
    alert("Incorrect password. Access denied.");
    document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;color:red;'>Access Denied</h2>";
    throw new Error("Access denied");
  }

  // ----- FIREBASE -----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
    authDomain: "adwatchrewardsapp.firebaseapp.com",
    projectId: "adwatchrewardsapp",
    storageBucket: "adwatchrewardsapp.firebasestorage.app",
    messagingSenderId: "782268735936",
    appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
    measurementId: "G-4NG2564HTK"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  document.getElementById("dashboard").style.display = "block";

  const tBody = document.getElementById("tBody");
  const refreshBtn = document.getElementById("refreshBtn");
  const exportCsvBtn = document.getElementById("exportCsv");
  const autoChk = document.getElementById("autoRefresh");
  let autoTimer = null;

  // ---- LOAD DASHBOARD ----
  async function loadDashboard(){
    tBody.innerHTML = "<tr><td colspan='7'>Loading…</td></tr>";

    const now = Date.now();
    const DAY_24 = 24*60*60*1000;

    const usersSnap = await getDocs(collection(db, "users"));
    let rows = [];

    usersSnap.forEach(docSnap=>{
      const data = docSnap.data();
      const invited = data.invitedUsers || [];
      let total = invited.length;
      let active = invited.filter(u=>now - u.timestamp <= DAY_24).length;
      let offline = total - active;
      let fake = invited.reduce((acc,u,idx)=>{
        let dup = invited.filter(x=>x.ip===u.ip).length;
        if(dup>1) acc +=1;
        return acc;
      },0);

      // Score calculation based on CPM / group
      let score = invited.reduce((acc,u)=>{
        if(u.group === "premium") return acc+500;
        if(u.group === "europe") return acc+370;
        if(u.group === "middleeast") return acc+350;
        if(u.group === "asia") return acc+130;
        return acc+10;
      },0);

      rows.push({
        name: data.name || docSnap.id,
        total, active, offline, fake, score
      });
    });

    // Sort by score descending
    rows.sort((a,b)=>b.score - a.score);

    // Render
    let html = "";
    rows.forEach((r,i)=>{
      html+=`<tr>
        <td>${i+1}</td>
        <td>${r.name}</td>
        <td>${r.total}</td>
        <td>${r.active}</td>
        <td>${r.offline}</td>
        <td>${r.fake}</td>
        <td>${r.score}</td>
      </tr>`;
    });
    tBody.innerHTML = html;
  }

  refreshBtn.addEventListener("click",()=>loadDashboard());
  exportCsvBtn.addEventListener("click",()=>{
    let csv = "Rank,Name,Total,Active,Offline,Fake,Score\n";
    const rows = Array.from(tBody.querySelectorAll("tr"));
    rows.forEach(r=>{
      const c = r.querySelectorAll("td");
      if(c.length===7){
        csv+=`${c[0].textContent},${c[1].textContent},${c[2].textContent},${c[3].textContent},${c[4].textContent},${c[5].textContent},${c[6].textContent}\n`;
      }
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "affiliate_dashboard.csv";
    a.click();
  });

  autoChk.addEventListener("change",()=>{
    if(autoChk.checked){
      autoTimer = setInterval(loadDashboard,10000);
    }else{
      clearInterval(autoTimer);
      autoTimer = null;
    }
  });

  loadDashboard();
</script>
</body>
</html>
