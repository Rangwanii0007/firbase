<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Affiliate Admin Dashboard</title>
<style>
  body{font-family:Arial,sans-serif;background:#f0f2f7;margin:0;padding:0}
  .card{max-width:1000px;margin:30px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border:1px solid #ddd;text-align:center}
  th{background:#f5f7fa;color:#333}
  .badge{padding:4px 8px;border-radius:6px;color:#fff;font-size:12px}
  .badge1{background:#ff4d4d} .badge2{background:#ff944d} .badge3{background:#ffdb4d} .badge4{background:#4dff88} .badge5{background:#4dd2ff}
  button{padding:6px 10px;border-radius:6px;border:none;background:#4d79ff;color:#fff;cursor:pointer}
  #search{margin:10px 0;padding:6px;width:200px;border-radius:6px;border:1px solid #ccc}
</style>
</head>
<body>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// --- Password Protection ---
const password = prompt("Enter Admin Password:");
if(password !== "nadeem"){ alert("Wrong password"); throw new Error("Unauthorized"); }

// ----- Firebase Config -----
const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- HTML Elements ---
document.body.innerHTML = `<div class="card">
  <h2>Affiliate Leaderboard (Realtime)</h2>
  <input type="text" id="search" placeholder="Search name...">
  <table id="tbl">
    <thead>
      <tr>
        <th>Rank</th><th>Name</th><th>Email</th><th>Total Invites</th><th>Active (24h)</th><th>Offline</th><th>Fake</th><th>Active %</th><th>Total Score</th><th>Details</th>
      </tr>
    </thead>
    <tbody id="tBody"><tr><td colspan="10">Loadingâ€¦</td></tr></tbody>
  </table>
</div>`;

const tBody = document.getElementById("tBody");
const searchInput = document.getElementById("search");

function calculateStats(refName, docs){
  const totalInvites = docs.length;
  const now = new Date();
  let active = 0, offline = 0, fake = 0, totalScore=0;
  docs.forEach(d=>{
    const ts = new Date(d.timestamp);
    if((now - ts)/1000/60/60 < 24) active++;
    else offline++;
    if(d.fake) fake++;
    totalScore += Number(d.score || 0);
  });
  const activePercent = totalInvites? Math.round((active/totalInvites)*100):0;
  return {totalInvites, active, offline, fake, activePercent, totalScore};
}

// --- Load leaderboard ---
function loadLeaderboard(){
  onSnapshot(collection(db,"referrals"), snapshot=>{
    const data = {};
    snapshot.docs.forEach(d=>{
      const doc = d.data();
      const name = doc.refName || "unknown";
      if(!data[name]) data[name]=[];
      data[name].push(doc);
    });

    // Convert to array & sort by totalScore
    const leaderboard = Object.entries(data).map(([name, docs])=>{
      const stats = calculateStats(name, docs);
      return {name, email:docs[0].email || 'N/A', ...stats, docs};
    });
    leaderboard.sort((a,b)=>b.totalScore - a.totalScore);

    // Render table
    let html = "";
    leaderboard.forEach((u,i)=>{
      const badge = i<3?`<span class="badge badge${i+1}">TOP ${i+1}</span>`:"";
      html+=`<tr>
        <td>${i+1} ${badge}</td>
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${u.totalInvites}</td>
        <td>${u.active}</td>
        <td>${u.offline}</td>
        <td>${u.fake}</td>
        <td>${u.activePercent}%</td>
        <td>${u.totalScore}</td>
        <td><button onclick='alert(JSON.stringify(${JSON.stringify(u.docs)},null,2))'>Details</button></td>
      </tr>`;
    });
    tBody.innerHTML = html;
  });
}

searchInput.addEventListener("input", ()=> loadLeaderboard());

loadLeaderboard();
</script>
</body>
</html>
