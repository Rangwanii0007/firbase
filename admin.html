<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Affiliate Admin Dashboard</title>
<style>
body{font-family:Arial,sans-serif;background:#f5f5f7;margin:0;padding:0}
#loginBox{width:300px;margin:50px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
#dashboard{display:none;padding:20px}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;border:1px solid #eee;text-align:center}
th{background:#f0f6ff}
button{padding:6px 10px;border-radius:6px;border:none;background:#2d89ff;color:#fff;cursor:pointer}
.details-btn{background:#ff7a45;color:#fff;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:80%;max-height:80%;overflow:auto}
.rank1{color:#ffb400;font-weight:bold}
.rank2{color:#4caf50;font-weight:bold}
.rank3{color:#2196f3;font-weight:bold}
</style>
</head>
<body>

<div id="loginBox">
  <h2>Admin Login</h2>
  <input type="text" id="username" placeholder="Username"><br><br>
  <input type="password" id="password" placeholder="Password"><br><br>
  <button id="loginBtn">Login</button>
</div>

<div id="dashboard">
  <h2>Affiliate Leaderboard (Realtime)</h2>
  <p>Active = visited in last 24h · Fake = multiple accounts from same IP</p>
  <table>
    <thead>
      <tr>
        <th>Rank</th><th>Name</th><th>Total Invites</th><th>Active (24h)</th><th>Offline</th><th>Fake</th><th>Active %</th><th>Total Score</th><th>Details</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="9">Loading…</td></tr>
    </tbody>
  </table>
</div>

<div class="modal" id="detailsModal">
  <div class="modal-content">
    <h3>Referral Details</h3>
    <table>
      <thead>
        <tr><th>Name</th><th>Email</th><th>Country</th><th>IP</th><th>Active (24h)</th></tr>
      </thead>
      <tbody id="detailsBody"></tbody>
    </table>
    <button id="closeModal">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// LOGIN
document.getElementById('loginBtn').onclick = ()=>{
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(u==='admin' && p==='nadeem'){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('dashboard').style.display='block';
    loadLeaderboard();
  } else alert('Invalid credentials!');
};

// Country CPM scores
const countryScores = {
  'Asia':130,'Europe':370,'Middle East':350,'USA':500,'Canada':500,'UK':500
};
function getCountryScore(country){ return countryScores[country]||10; }

// Load leaderboard
async function loadLeaderboard(){
  const snap = await getDocs(collection(db,'referrals'));
  const affiliates = {};
  const now = new Date();

  snap.forEach(doc=>{
    const d = doc.data();
    const name = d.referrer || 'unknown';
    const country = d.country || 'Unknown';
    const ip = d.ip || '';
    const ts = d.timestamp?.toDate ? d.timestamp.toDate() : now;

    if(!affiliates[name]) affiliates[name]={total:0,active:0,offline:0,fake:0,ips:{},users:[]};
    affiliates[name].total++;
    const isActive = ((now - ts)/36e5)<=24;
    if(isActive) affiliates[name].active++; else affiliates[name].offline++;
    affiliates[name].users.push({ ...d, active:isActive });
    affiliates[name].ips[ip] = (affiliates[name].ips[ip]||0)+1;
  });

  // Fake calculation
  Object.keys(affiliates).forEach(name=>{
    let f=0;
    Object.values(affiliates[name].ips).forEach(v=>{ if(v>1) f+=v-1; });
    affiliates[name].fake=f;
  });

  // Compute active % and score
  const leaderboard = [];
  Object.keys(affiliates).forEach(name=>{
    const a = affiliates[name];
    const activePerc = Math.round((a.active/a.total)*100);
    let score=0;
    a.users.forEach(u=>{ score += 10 + getCountryScore(u.country); });
    leaderboard.push({...a,name,activePerc,score});
  });

  leaderboard.sort((a,b)=>b.score-a.score);

  // Render table
  const tbody = document.getElementById('tbody');
  tbody.innerHTML='';
  leaderboard.forEach((a,i)=>{
    const rankClass = i===0?'rank1':i===1?'rank2':i===2?'rank3':'';
    const row = document.createElement('tr');
    row.innerHTML=`
      <td class="${rankClass}">${i+1}</td>
      <td>${a.name}</td>
      <td>${a.total}</td>
      <td>${a.active}</td>
      <td>${a.offline}</td>
      <td>${a.fake}</td>
      <td>${a.activePerc}%</td>
      <td>${a.score}</td>
      <td><button class="details-btn" data-name="${a.name}">Details</button></td>
    `;
    tbody.appendChild(row);
  });

  // Modal details
  document.querySelectorAll('.details-btn').forEach(btn=>{
    btn.onclick = ()=>{
      const name = btn.getAttribute('data-name');
      const detailsBody = document.getElementById('detailsBody');
      detailsBody.innerHTML='';
      affiliates[name].users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${name}</td><td>${u.email||'N/A'}</td><td>${u.country}</td><td>${u.ip}</td><td>${u.active?'Yes':'No'}</td>`;
        detailsBody.appendChild(tr);
      });
      document.getElementById('detailsModal').style.display='flex';
    };
  });

  document.getElementById('closeModal').onclick = ()=>{ document.getElementById('detailsModal').style.display='none'; };
}

// Auto refresh leaderboard every 30 seconds
setInterval(()=>{ if(document.getElementById('dashboard').style.display==='block') loadLeaderboard(); },30000);

</script>
</body>
</html>
