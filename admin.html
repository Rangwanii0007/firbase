<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Referral Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    th, td { padding:10px; text-align:center; border:1px solid #ddd; }
    th { background:#222; color:#fff; }
    tr:nth-child(even){background:#f9f9f9;}
  </style>
</head>
<body>
  <h2>Referral Engagement Dashboard</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Gmail</th>
        <th>Total Users</th>
        <th>Active Users (24h)</th>
        <th>Offline Users</th>
        <th>Fake Users (Same IP)</th>
      </tr>
    </thead>
    <tbody id="stats-body">
      <tr><td colspan="6">Loading…</td></tr>
    </tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadStats() {
      const tbody = document.getElementById("stats-body");
      tbody.innerHTML = "<tr><td colspan='6'>Fetching data…</td></tr>";

      const usersSnap = await getDocs(collection(db, "users"));
      if (usersSnap.empty) {
        tbody.innerHTML = "<tr><td colspan='6'>No data found</td></tr>";
        return;
      }

      const inviterStats = {};

      usersSnap.forEach(doc => {
        const user = doc.data();
        const inviter = user.inviter || "Unknown";
        const gmail = user.email || "N/A";
        const lastSeen = user.lastSeen ? new Date(user.lastSeen.toDate ? user.lastSeen.toDate() : user.lastSeen) : null;
        const ip = user.ip || "0.0.0.0";

        if (!inviterStats[inviter]) {
          inviterStats[inviter] = { gmail, total:0, active:0, offline:0, fake:0, ips:{} };
        }

        inviterStats[inviter].total++;

        if (lastSeen) {
          const diff = (Date.now() - lastSeen.getTime()) / (1000*60*60); // hours
          if (diff <= 24) inviterStats[inviter].active++;
          else inviterStats[inviter].offline++;
        } else {
          inviterStats[inviter].offline++;
        }

        if (inviterStats[inviter].ips[ip]) {
          inviterStats[inviter].fake++;
        } else {
          inviterStats[inviter].ips[ip] = true;
        }
      });

      tbody.innerHTML = "";
      for (let name in inviterStats) {
        const s = inviterStats[name];
        tbody.innerHTML += `
          <tr>
            <td>${name}</td>
            <td>${s.gmail}</td>
            <td>${s.total}</td>
            <td>${s.active}</td>
            <td>${s.offline}</td>
            <td>${s.fake}</td>
          </tr>
        `;
      }
    }

    loadStats();
  </script>
</body>
</html>
