<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Affiliate Dashboard</title>
<style>
body{font-family:Arial,sans-serif;background:#f5f7fb;padding:20px;}
.card{max-width:1200px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.06);}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border:1px solid #eee;text-align:center;}
th{background:#f0f6ff;}
button{padding:5px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;}
.small{font-size:13px;color:#666;}
</style>
</head>
<body>

<div class="card" id="dashboard" style="display:none;">
  <h2>Affiliate Leaderboard (Realtime)</h2>
  <p class="small">Active = last 24h · Fake = same IP · Scores CPM-based</p>
  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Gmail</th>
        <th>Total Users</th>
        <th>Active (24h)</th>
        <th>Offline</th>
        <th>Fake</th>
        <th>Active %</th>
        <th>Total Score</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="tBody">
      <tr><td colspan="10">Loading…</td></tr>
    </tbody>
  </table>
</div>

<!-- User Details Modal -->
<div id="detailsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);overflow:auto;">
  <div style="background:#fff;margin:50px auto;padding:20px;border-radius:10px;max-width:800px;">
    <h3 id="detailsTitle">Details</h3>
    <table id="detailsTable" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Country</th><th>IP</th><th>Active</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="document.getElementById('detailsModal').style.display='none'">Close</button>
  </div>
</div>

<script type="module">
  // ----- PASSWORD PROTECTION -----
  const password = prompt("Enter Admin Password:");
  if(password !== "nadeem"){
    alert("Wrong password! Access denied.");
    document.body.innerHTML="<h2 style='text-align:center;margin-top:50px;color:red;'>Access Denied</h2>";
    throw new Error("Access denied");
  }

  // ----- FIREBASE -----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
    authDomain: "adwatchrewardsapp.firebaseapp.com",
    projectId: "adwatchrewardsapp",
    storageBucket: "adwatchrewardsapp.firebasestorage.app",
    messagingSenderId: "782268735936",
    appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
    measurementId: "G-4NG2564HTK"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  document.getElementById("dashboard").style.display="block";

  const tBody = document.getElementById("tBody");
  const detailsModal = document.getElementById("detailsModal");
  const detailsTableBody = detailsModal.querySelector("tbody");
  const detailsTitle = document.getElementById("detailsTitle");

  async function loadDashboard(){
    tBody.innerHTML="<tr><td colspan='10'>Loading…</td></tr>";
    const usersSnap = await getDocs(collection(db,"users"));
    const now = Date.now();
    const DAY_24 = 24*60*60*1000;
    let rows=[];

    usersSnap.forEach(docSnap=>{
      const data=docSnap.data();
      const invited=data.invitedUsers || [];
      const total=invited.length;
      const active=invited.filter(u=>now-u.timestamp<=DAY_24).length;
      const offline=total-active;
      const fake=invited.reduce((acc,u,i)=>acc + (invited.filter(x=>x.ip===u.ip).length>1?1:0),0);

      const activePercent = total>0 ? Math.round(active/total*100) : 0;

      // CPM Score
      const score = invited.reduce((acc,u)=>{
        if(u.country==="USA"||u.country==="CANADA"||u.country==="UK") return acc+500;
        if(u.country==="Europe") return acc+370;
        if(u.country==="MiddleEast") return acc+350;
        if(u.country==="Asia") return acc+130;
        return acc+10;
      },0);

      rows.push({name:data.name||docSnap.id,email:data.email||"",total,active,offline,fake,activePercent,score,invited});
    });

    rows.sort((a,b)=>b.score-a.score);

    let html="";
    rows.forEach((r,i)=>{
      html+=`<tr>
        <td>${i+1}</td>
        <td>${r.name}</td>
        <td>${r.email}</td>
        <td>${r.total}</td>
        <td>${r.active}</td>
        <td>${r.offline}</td>
        <td>${r.fake}</td>
        <td>${r.activePercent}%</td>
        <td>${r.score}</td>
        <td><button onclick='showDetails(${i})'>Details</button></td>
      </tr>`;
    });

    tBody.innerHTML=html;

    // store rows globally
    window.dashboardRows=rows;
  }

  function showDetails(index){
    const user=window.dashboardRows[index];
    detailsTitle.innerText="Details for "+user.name;
    let html="";
    user.invited.forEach(u=>{
      const active=Date.now()-u.timestamp<=24*60*60*1000?"Yes":"No";
      html+=`<tr>
        <td>${user.name}</td>
        <td>${u.email||"---"}</td>
        <td>${u.country||"---"}</td>
        <td>${u.ip||"---"}</td>
        <td>${active}</td>
      </tr>`;
    });
    detailsTableBody.innerHTML=html;
    detailsModal.style.display="block";
  }

  loadDashboard();
  setInterval(loadDashboard,10000);
</script>
</body>
</html>
