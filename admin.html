<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Affiliate Leaderboard - Admin</title>
<style>
body{font-family:'Segoe UI',sans-serif;margin:0;background:#f0f3f7;}
.login-box{display:flex;justify-content:center;align-items:center;height:100vh;}
.login-form{background:#fff;padding:30px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.2);width:320px;text-align:center;}
.login-form input{width:90%;padding:10px;margin:10px 0;border-radius:8px;border:1px solid #ccc;}
.login-form button{padding:10px 20px;border:none;background:#4CAF50;color:#fff;font-weight:bold;border-radius:8px;cursor:pointer;}
.dashboard{padding:20px;display:none;}
h1{color:#333;text-align:center;}
table{width:100%;border-collapse:collapse;margin-top:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
th,td{text-align:center;padding:12px;border-bottom:1px solid #eee;}
th{background:#4CAF50;color:white;position:sticky;top:0;}
tr:hover{background:#f1f1f1;}
.badge{padding:4px 8px;border-radius:8px;color:#fff;font-weight:bold;}
.rank1{background:#FFD700;} .rank2{background:#C0C0C0;} .rank3{background:#CD7F32;}
button.details-btn{padding:5px 10px;border:none;background:#2196F3;color:white;border-radius:6px;cursor:pointer;}
#detailsModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;}
#detailsContent{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:800px;max-height:80vh;overflow:auto;}
#closeModal{float:right;cursor:pointer;color:red;font-weight:bold;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox" class="login-box">
  <div class="login-form">
    <h2>Admin Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="dashboard">
  <h1>Affiliate Leaderboard (Realtime)</h1>
  <div style="text-align:right;"><button id="exportCsv">Export CSV</button></div>
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Total Invites</th>
        <th>Active (24h)</th>
        <th>Offline</th>
        <th>Fake</th>
        <th>Active %</th>
        <th>Total Score</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="9">Loadingâ€¦</td></tr>
    </tbody>
  </table>
</div>

<!-- DETAILS MODAL -->
<div id="detailsModal">
  <div id="detailsContent">
    <span id="closeModal">X</span>
    <h3>Affiliate Details</h3>
    <table id="detailsTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Country</th><th>IP</th><th>Active</th></tr>
      </thead>
      <tbody id="detailsBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// LOGIN
document.getElementById('loginBtn').onclick = ()=>{
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(u==='admin' && p==='nadeem'){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('dashboard').style.display='block';
    loadLeaderboard();
  }else alert('Invalid credentials!');
};

// CPM Scores
const countryScores = {
  'Asia':130,'Europe':370,'Middle East':350,'USA':500,'Canada':500,'UK':500
};
function getCountryScore(country){ return countryScores[country]||10; }

// LOAD LEADERBOARD
async function loadLeaderboard(){
  const snap = await getDocs(collection(db,'referrals'));
  const affiliates = {};
  const now = new Date();

  snap.forEach(doc=>{
    const d = doc.data();
    const name = d.referrer || 'unknown';
    const country = d.country || '';
    const ip = d.ip || '';
    const ts = d.timestamp ? d.timestamp.toDate() : now;

    if(!affiliates[name]) affiliates[name]={total:0,active:0,offline:0,fake:0,ips:{},users:[]};
    affiliates[name].total++;
    affiliates[name].users.push(d);
    affiliates[name].ips[ip] = (affiliates[name].ips[ip]||0)+1;

    const diffH = (now - ts)/36e5;
    if(diffH<=24) affiliates[name].active++;
    else affiliates[name].offline++;
  });

  // Calculate fake users
  Object.keys(affiliates).forEach(name=>{
    let f=0;
    Object.values(affiliates[name].ips).forEach(v=>{ if(v>1) f+=v-1; });
    affiliates[name].fake=f;
  });

  // Calculate Active % and Score
  const leaderboard = [];
  Object.keys(affiliates).forEach(name=>{
    const a = affiliates[name];
    const activePerc = Math.round((a.active/a.total)*100);
    let score = 0;
    a.users.forEach(u=>{ score += 10 + getCountryScore(u.country); });
    leaderboard.push({...a,name,activePerc,score});
  });

  // Sort by score
  leaderboard.sort((a,b)=>b.score-a.score);

  const tbody = document.getElementById('tbody');
  tbody.innerHTML='';
  leaderboard.forEach((a,i)=>{
    const rankClass = i===0?'rank1':i===1?'rank2':i===2?'rank3':'';
    const row = document.createElement('tr');
    row.innerHTML=`
      <td class="${rankClass}">${i+1}</td>
      <td>${a.name}</td>
      <td>${a.total}</td>
      <td>${a.active}</td>
      <td>${a.offline}</td>
      <td>${a.fake}</td>
      <td>${a.activePerc}%</td>
      <td>${a.score}</td>
      <td><button class="details-btn" data-name="${a.name}">Details</button></td>
    `;
    tbody.appendChild(row);
  });

  // Details Modal
  document.querySelectorAll('.details-btn').forEach(btn=>{
    btn.onclick = async ()=>{
      const name = btn.getAttribute('data-name');
      const detailsBody = document.getElementById('detailsBody');
      detailsBody.innerHTML='';
      const d = affiliates[name].users;
      d.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${name}</td><td>${u.email||'N/A'}</td><td>${u.country}</td><td>${u.ip}</td><td>${u.active?'Yes':'No'}</td>`;
        detailsBody.appendChild(tr);
      });
      document.getElementById('detailsModal').style.display='flex';
    };
  });

  document.getElementById('closeModal').onclick = ()=>{ document.getElementById('detailsModal').style.display='none'; };
}

// Auto refresh every 30 seconds
setInterval(()=>{ if(document.getElementById('dashboard').style.display==='block') loadLeaderboard(); },30000);
</script>
