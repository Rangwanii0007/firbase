<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Affiliate Admin — Classic</title>
<style>
  :root{ --bg:#0b0f12; --panel:#071014; --accent:#00d48a; --muted:#7fbfb0; --card:#071a1a; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#000,#07121a);color:#d9fff0;font-family:ui-monospace,monospace}
  .wrap{max-width:1200px;margin:14px auto;padding:12px}
  .login{background:var(--card);padding:12px;border-radius:8px;display:flex;gap:8px;align-items:center}
  input,button,select{background:#021617;border:1px solid rgba(0,212,138,0.12);color:#dff; padding:8px;border-radius:6px}
  button{cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:12px;margin-top:12px}
  .card{background:linear-gradient(180deg,#001a1a,#021e22);padding:12px;border-radius:8px;border:1px solid rgba(0,212,138,0.06)}
  .title{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
  thead th{background:rgba(0,0,0,0.25);position:sticky;top:0}
  .muted{color:var(--muted);font-size:13px}
  .feed{margin-top:8px;max-height:200px;overflow:auto;border-top:1px solid rgba(255,255,255,0.02);padding-top:8px}
  .feedRow{display:flex;gap:8px;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.2)}
  @media(max-width:900px){ .grid{grid-template-columns:1fr} .card{padding:10px} table td,table th{padding:6px;font-size:12px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="title"><div class="dot"></div> Affiliate Admin — Classic</div>

  <!-- login -->
  <div id="loginCard" class="login">
    <input id="user" placeholder="username" value="admin">
    <input id="pass" placeholder="password" type="password">
    <button id="loginBtn">Open Dashboard</button>
    <div style="margin-left:auto" class="muted">Hint: admin / nadeem</div>
  </div>

  <!-- dashboard -->
  <div id="dash" style="display:none">
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Realtime Leaderboard</strong>
          <div class="muted">Live · updates automatically</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <input id="search" placeholder="Search name or email">
          <select id="refFilter"><option value="">Filter referrer</option></select>
          <button id="exportBtn">Export CSV</button>
          <button id="refreshBtn">Refresh</button>
        </div>

        <table style="margin-top:10px">
          <thead><tr><th>Rank</th><th>Name</th><th>Email</th><th>Total</th><th>Active(24h)</th><th>Offline</th><th>Fake(same IP)</th><th>Active%</th><th>Score</th><th>Details</th></tr></thead>
          <tbody id="leaderBody"><tr><td colspan="10" class="muted">Waiting for data…</td></tr></tbody>
        </table>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Feed</strong>
          <div class="muted">Most recent joins</div>
        </div>
        <div class="feed" id="feed"></div>

        <div style="margin-top:12px">
          <strong>Totals</strong>
          <div class="muted" style="margin-top:6px">Total invites: <span id="totalInv">0</span></div>
          <div class="muted">Active(24h): <span id="totalActive">0</span></div>
          <div class="muted">Unique IPs: <span id="uniqueIPs">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- details dialog (simple) -->
<dialog id="detailsDlg">
  <div style="padding:12px;min-width:320px">
    <h3 id="detailsTitle">Details</h3>
    <div id="detailsSummary" class="muted"></div>
    <table style="width:100%;margin-top:8px"><thead><tr><th>Email</th><th>Verified</th><th>Country</th><th>IP</th><th>When</th><th>Active</th></tr></thead>
      <tbody id="detailsBody"></tbody>
    </table>
    <div style="margin-top:8px;text-align:right"><button id="closeDetails">Close</button></div>
  </div>
</dialog>

<script type="module">
/*
  admin.html (classic)
  - realtime listener on 'referrals' collection
  - aggregates by referrer (lowercased)
  - shows totals, active(24h), fake counts (same IP), per-referrer details
  - simple login gate (admin/nadeem)
*/

// --- FIREBASE (your project's config) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDaAMcSZSigXawYiD7ThoB-kXMdoa9cgyY",
  authDomain: "adwatchrewardsapp.firebaseapp.com",
  projectId: "adwatchrewardsapp",
  storageBucket: "adwatchrewardsapp.firebasestorage.app",
  messagingSenderId: "782268735936",
  appId: "1:782268735936:web:ea82e5be5d0f44949ba825",
  measurementId: "G-4NG2564HTK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// UI refs
const loginBtn = document.getElementById('loginBtn'), userEl = document.getElementById('user'), passEl = document.getElementById('pass');
const loginCard = document.getElementById('loginCard'), dash = document.getElementById('dash');
const leaderBody = document.getElementById('leaderBody'), feed = document.getElementById('feed');
const totalInvEl = document.getElementById('totalInv'), totalActiveEl = document.getElementById('totalActive'), uniqueIPsEl = document.getElementById('uniqueIPs');
const exportBtn = document.getElementById('exportBtn'), refreshBtn = document.getElementById('refreshBtn');
const refFilter = document.getElementById('refFilter'), searchEl = document.getElementById('search');

// details dialog
const detailsDlg = document.getElementById('detailsDlg'), detailsTitle = document.getElementById('detailsTitle'), detailsBody = document.getElementById('detailsBody'), detailsSummary = document.getElementById('detailsSummary');
const closeDetails = document.getElementById('closeDetails'); closeDetails.onclick = ()=> detailsDlg.close();

// login handler (simple local gate)
loginBtn.onclick = () => {
  if(userEl.value.trim() === 'admin' && passEl.value.trim() === 'nadeem'){
    loginCard.style.display = 'none';
    dash.style.display = 'block';
    startRealtime();
  } else {
    alert('Wrong credentials');
  }
};

// helpers
function isActive24(ts){
  if(!ts) return false;
  const t = ts.toDate ? ts.toDate().getTime() : (new Date(ts)).getTime();
  return (Date.now() - t) <= 24*60*60*1000;
}
function niceTime(ts){
  if(!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleString();
}
function regionScore(country){
  if(!country) return 130;
  const c = (country||'').toLowerCase();
  if(['usa','united states','canada','uk','united kingdom'].some(x=>c.includes(x))) return 500;
  if(['germany','france','italy','spain','netherlands'].some(x=>c.includes(x))) return 370;
  if(['uae','saudi','qatar','kuwait'].some(x=>c.includes(x))) return 350;
  return 130;
}

// realtime listener
let raw = [];
function startRealtime(){
  const q = query(collection(db, 'referrals'), );
  onSnapshot(q, snap => {
    raw = snap.docs.map(d => d.data());
    renderAll();
  }, err => {
    console.error("onSnapshot error:", err);
  });
}

function aggregate(){
  const by = {};
  raw.forEach(doc => {
    const name = (doc.referrer || doc.referrerRaw || 'unknown').toString().toLowerCase();
    if(!by[name]) by[name] = { name, email:'N/A', visits: [] };
    if(doc.email && doc.email !== 'N/A' && by[name].email === 'N/A') by[name].email = doc.email;
    by[name].visits.push(doc);
  });

  const rows = [];
  Object.values(by).forEach(e => {
    let total=0, active=0, offline=0, fake=0, score=0;
    const ipCount = {}, countries = {};
    e.visits.forEach(v => {
      total++;
      if(isActive24(v.ts)) active++; else offline++;
      ipCount[v.ip || ''] = (ipCount[v.ip || ''] || 0) + 1;
      const c = v.country || 'Unknown'; countries[c] = (countries[c]||0)+1;
      score += (v.score || (10 + regionScore(c)));
    });
    Object.values(ipCount).forEach(n => { if(n>1) fake += (n-1); });
    const activePct = total ? Math.round(active/total*100) : 0;
    rows.push({ name: e.name, email: e.email, total, active, offline, fake, activePct, score, visits: e.visits, countries });
  });

  rows.sort((a,b) => b.score - a.score);
  return rows;
}

function renderAll(){
  // header totals
  totalInvEl.textContent = raw.length;
  totalActiveEl.textContent = raw.filter(r => isActive24(r.ts)).length;
  uniqueIPsEl.textContent = [...new Set(raw.map(r => r.ip || ''))].length;

  // refill feed (most recent 30)
  const recent = raw.slice(-40).reverse();
  feed.innerHTML = '';
  recent.forEach(r => {
    const div = document.createElement('div');
    div.className = 'feedRow';
    div.innerHTML = `<div style="flex:1">${(r.email && r.email!=='N/A')? r.email : '<span class="muted">Unknown</span>'}</div>
                     <div style="width:110px;text-align:right">${r.country || '<span class="muted">N/A</span>'}</div>
                     <div style="width:120px;text-align:right">${r.ip || 'N/A'}</div>
                     <div style="width:100px;text-align:right">${(r.referrer||'unknown').toUpperCase()}</div>`;
    feed.appendChild(div);
  });

  // leaderboard
  const rows = aggregate();

  // populate filter select
  refFilter.innerHTML = `<option value="">Filter referrer</option>` + rows.map(r => `<option value="${r.name}">${r.name.toUpperCase()}</option>`).join('');

  // apply search / filter
  const q = (searchEl.value || '').toLowerCase();
  const filter = refFilter.value || '';
  const filtered = rows.filter(r => (r.name.includes(q) || (r.email||'').toLowerCase().includes(q)) && (filter ? r.name === filter : true));

  if(filtered.length === 0){
    leaderBody.innerHTML = `<tr><td colspan="10" class="muted">No data</td></tr>`;
  } else {
    leaderBody.innerHTML = filtered.map((r,i) => `
      <tr>
        <td>${i+1}</td>
        <td>${r.name.toUpperCase()}</td>
        <td>${r.email}</td>
        <td>${r.total}</td>
        <td>${r.active}</td>
        <td>${r.offline}</td>
        <td>${r.fake}</td>
        <td>${r.activePct}%</td>
        <td>${r.score}</td>
        <td><button class="detailBtn" data-name="${r.name}">Details</button></td>
      </tr>
    `).join('');
  }

  // attach detail buttons
  document.querySelectorAll('.detailBtn').forEach(btn => {
    btn.onclick = () => {
      const name = btn.dataset.name;
      const row = rows.find(x => x.name === name);
      if(!row) return;
      detailsTitle.textContent = `Details — ${name.toUpperCase()}`;
      detailsSummary.textContent = Object.entries(row.countries || {}).map(([c,n]) => `${c}: ${n}`).join(' · ');
      detailsBody.innerHTML = row.visits.map(v => `<tr>
        <td>${v.email || 'N/A'}</td>
        <td>${v.verified ? 'Yes' : 'No'}</td>
        <td>${v.country || 'Unknown'}</td>
        <td>${v.ip || 'N/A'}</td>
        <td>${niceTime(v.ts)}</td>
        <td>${isActive24(v.ts) ? 'Yes' : 'No'}</td>
      </tr>`).join('');
      detailsDlg.showModal();
    };
  });
}

// CSV export
exportBtn.onclick = () => {
  const rows = aggregate();
  let csv = 'Rank,Name,Email,Total,Active24,Offline,Fake,ActivePercent,Score\n';
  rows.forEach((r,i) => {
    csv += [i+1, r.name, r.email, r.total, r.active, r.offline, r.fake, r.activePct + '%', r.score].join(',') + '\n';
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = 'leaderboard.csv';
  a.click();
};

// interactions
searchEl.addEventListener('input', renderAll);
refFilter.addEventListener('change', renderAll);
refreshBtn.addEventListener('click', renderAll);

// startRealtime called on login success above

</script>
</body>
</html>
